{"version":3,"file":"index.js","sources":["../src/core/utils.js","../src/core/observable.js","../src/index.js"],"sourcesContent":["function checkType (obj) {\n  // return object array function undefined null number...\n  let type = typeof obj;\n  if (type === 'object') {\n    if (!obj) return 'null';\n    if (obj.constructor === Array) return 'array';\n  }\n  return type;\n}\n// 非纯函数，照顾到 schema， 不更改引用\nfunction deepMerge(obj1, obj2) {\n  let type1 = checkType(obj1)\n  const type2 = checkType(obj2)\n  if (type2 === 'array' || type2 === 'object') {\n    if (type1 !== type2) {\n      obj1 = obj2;\n    } else {\n      for (let key in obj2) {\n        if (key in obj1) {\n          obj1[key] = obj2[key]\n        }\n      }\n    }\n  }\n  obj1 = obj2;\n  return obj1;\n}\n\nexport {\n  checkType\n}","import {checkType} from './utils';\nobservable.ArrayPropConf = new Set(['push', 'pop', 'shift', 'unshift', 'splice', 'sort']);\nobservable.taskList = []; // 需要去重\nobservable.taskList.push = function(value, listener) {\n  observable.taskList[observable.taskList.length] = value;\n  observable.runner(listener);\n}\nobservable.runner = function (fn) {\n  Promise.resolve()\n    .then(() => {\n      for (let i = 0; i < observable.taskList.length; i++) {\n        fn(observable.taskList.shift())\n      }\n    })\n}\n\n\nobservable.getHandler = function (schema, type, keys, listener) {\n  // 不要更改参数，因为它们是闭包～\n  const handler = {\n    set(target, prop, value) {\n      let old = target[prop];\n      if (old !== value) {\n        // 当 target[prop] 在 schema 中是引用类型，需要让 value observable\n        if (schema && schema[prop]) {\n          value = observable(schema[prop], listener, keys, value);\n        }\n        target[prop] = value;\n        let newKeys = keys ? `${keys}${type === 'array' ? '[' + prop + ']' : '.' + prop}` : prop;\n        observable.taskList.push({old, now: value, keys: newKeys}, listener)\n      }\n      return true;\n    }\n  }\n  if (type === 'array') {\n    handler.get = function(target, prop) {\n      if (observable.ArrayPropConf.has(prop)) {\n        return function(...args) {\n          let old = target.slice();\n          target[prop](...args);\n          observable.taskList.push({old, now: target, keys}, listener)\n        }\n      }\n    }\n  }\n  return handler;\n}\n\n// 在 schema 引用发生变化时需要重新定义子 schema\nfunction observable(schema, listener = () => {}, rootKey = '', defaultValue) {\n  let result = defaultValue;\n  let type = checkType(schema);\n  if (type === 'object' || type === 'array') {\n    result = defaultValue || type === 'object' ? {} : [];\n    for (let key in schema) { // 注意，不是 for of\n      let keys = `${rootKey ? rootKey + '.' : ''}${key}`\n      result[key] = observable(schema[key], listener, keys, result[key]);\n    }\n    result = new Proxy(result, observable.getHandler(schema, type, rootKey, listener));\n  }\n  return result || defaultValue;\n}\n\n\nexport default observable\n\n","import observable from './core/observable';\n\nlet test = observable({\n  a: '',\n  b: {\n    b1: '',\n    b2: []\n  },\n  c: []\n}, ({keys, old, now}) => {\n  console.log(keys, old, now)\n});\n// console.log(test)\n\n// test observable\ntest.a = 1;\ntest.c.push(2);\ntest.b.b2.push(3);\n\n// test 更改引用后，仍然 observable\ntest.b = {\n  b1: 2,\n  b2: [4]\n}\n\ntest.b.b1 = 3;\n\ntest.d = 233;\n\nconsole.log(test)\n"],"names":["checkType","obj","type","constructor","Array","observable","ArrayPropConf","Set","taskList","push","value","listener","length","runner","fn","Promise","resolve","then","i","shift","getHandler","schema","keys","handler","set","target","prop","old","newKeys","now","get","has","slice","rootKey","defaultValue","result","key","Proxy","test","a","b","b1","b2","c","console","log","d"],"mappings":"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"}