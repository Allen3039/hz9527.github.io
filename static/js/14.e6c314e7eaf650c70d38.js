webpackJsonp([14],{RPdL:function(s,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n={render:function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("section",[a("h2",{attrs:{id:"小谈闭包closure"}},[s._v("小谈闭包closure")]),s._v(" "),a("div",{staticClass:"aside-menu"},[a("div",{directives:[{name:"toggle",rawName:"v-toggle"}],staticClass:"aside-menu-tit"},[s._v("menu")]),s._v(" "),s._m(0)]),a("b",{staticClass:"update-time"},[s._v(s._s(s._f("formatTime")(1551503379253)))]),a("b",{staticClass:"type"},[s._v("js")]),s._v(" "),a("b",{staticClass:"kw"},[s._v("闭包")]),s._v(" "),a("b",{staticClass:"kw"},[s._v("垃圾回收")]),s._v(" "),a("h3",{attrs:{id:"什么是闭包？"}},[s._v("什么是闭包？")]),s._v(" "),s._m(1),s._v(" "),a("p",[s._v("以上定义大概是看到的比较多的对闭包的定义。当然闭包有狭义的也有广义的，而大部分我们讨论的都是狭义的（外层函数执行完而其局部对象并不被销毁）")]),s._v(" "),a("h4",{attrs:{id:"闭包的形成原因"}},[s._v("闭包的形成原因")]),s._v(" "),a("p",[s._v("我们知道，在 js 中，当函数执行前，作用域会为该函数创建活动对象（当多层函数嵌套执行时就形成了作用域链），当函数执行完就会销毁这个作用域（活动对象），将作用域链 pop。而闭包则是由于内部函数访问了该函数的作用域并通过一些方式使得活动对象不能被释放")]),s._v(" "),s._m(2),s._v(" "),s._m(3),s._v(" "),a("h4",{attrs:{id:"狭义上的闭包的形成条件"}},[s._v("狭义上的闭包的形成条件")]),s._v(" "),s._m(4),s._v(" "),a("h3",{attrs:{id:"js 引擎的垃圾回收机制"}},[s._v("js 引擎的垃圾回收机制")]),s._v(" "),a("p",[s._v("或许说到这里大部分人会想到 引用计数、标记清除。实际上讲清楚 js 引擎垃圾回收就一句话 当内存不再需要使用时释放")]),s._v(" "),s._m(5),s._v(" "),s._m(6),s._v(" "),a("h3",{attrs:{id:"再看闭包"}},[s._v("再看闭包")]),s._v(" "),a("p",[s._v("其实在我们日常的代码中，闭包随处可见，简单的模块化实现，惰性单例，高阶函数等等都用到了闭包。个人经常会陷入一个怪圈，在一些多层传递的异步代码中由于使用了闭包，经常担心是否被回收？")]),s._v(" "),a("p",[s._v("举个例子，在封装小程序请求接口时希望将接口封装成 thenable 风格，并支持 abort，还支持最大十个并发，出现了以下代码")]),s._v(" "),s._m(7)])},staticRenderFns:[function(){var s=this.$createElement,t=this._self._c||s;return t("div",{staticClass:"aside-menu-con"},[t("a",{staticClass:"level-3 aside-menu-item",attrs:{href:"#什么是闭包？"}},[this._v("什么是闭包？")]),t("a",{staticClass:"level-4 aside-menu-item",attrs:{href:"#闭包的形成原因"}},[this._v("闭包的形成原因")]),t("a",{staticClass:"level-4 aside-menu-item",attrs:{href:"#狭义上的闭包的形成条件"}},[this._v("狭义上的闭包的形成条件")]),t("a",{staticClass:"level-3 aside-menu-item",attrs:{href:"#js 引擎的垃圾回收机制"}},[this._v("js 引擎的垃圾回收机制")]),t("a",{staticClass:"level-3 aside-menu-item",attrs:{href:"#再看闭包"}},[this._v("再看闭包")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("blockquote",[t("p",[this._v("闭包是指有权访问另一个函数作用域的变量的函数。闭包是函数和声明该函数的词法环境的组合。")])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("pre",{pre:!0},[a("code",{attrs:{"v-pre":"",class:"language-js"}},[a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v(" "),a("span",{attrs:{class:"hljs-title"}},[s._v("a")]),s._v("("),a("span",{attrs:{class:"hljs-params"}}),s._v(") ")]),s._v("{\n  "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("let")]),s._v(" b = "),a("span",{attrs:{class:"hljs-number"}},[s._v("0")]),s._v(";\n  "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" "),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("()")]),s._v(" =>")]),s._v(" b++\n}\n"),a("span",{attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" c = a()\n\n"),a("span",{attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" obj = {}\n"),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v(" "),a("span",{attrs:{class:"hljs-title"}},[s._v("d")]),s._v("("),a("span",{attrs:{class:"hljs-params"}}),s._v(") ")]),s._v("{\n  "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("let")]),s._v(" b = "),a("span",{attrs:{class:"hljs-number"}},[s._v("0")]),s._v(";\n  obj.fn = "),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("()")]),s._v(" =>")]),s._v(" b++\n}\nd()\n\n"),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v(" "),a("span",{attrs:{class:"hljs-title"}},[s._v("e")]),s._v("("),a("span",{attrs:{class:"hljs-params"}}),s._v(") ")]),s._v("{\n  "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("let")]),s._v(" b = "),a("span",{attrs:{class:"hljs-number"}},[s._v("0")]),s._v(";\n  setInterval("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("()")]),s._v(" =>")]),s._v(" b++, "),a("span",{attrs:{class:"hljs-number"}},[s._v("500")]),s._v(")\n}\n")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("blockquote",[t("p",[this._v("以上几种方式都能形成狭义上的闭包")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("ol",[t("li",[this._v("函数内部声明了函数")]),this._v(" "),t("li",[this._v("内部函数使用了该函数的局部变量")]),this._v(" "),t("li",[this._v("函数执行完后内部函数不被销毁")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("blockquote",[t("p",[this._v("从2012年起，所有现代浏览器都使用了标记-清除垃圾回收算法。所有对JavaScript垃圾回收算法的改进都是基于标记-清除算法的改进，并没有改进标记-清除算法本身和它对“对象是否不再需要”的简化定义。")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[t("a",{attrs:{href:"https://juejin.im/post/5b1f7e62e51d45068a6cb98f"}},[this._v("拓展阅读")])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("pre",{pre:!0},[a("code",{attrs:{"v-pre":"",class:"language-js"}},[s._v("\n"),a("span",{attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" MAX = "),a("span",{attrs:{class:"hljs-number"}},[s._v("10")]),s._v(";\n"),a("span",{attrs:{class:"hljs-keyword"}},[s._v("let")]),s._v(" counts = "),a("span",{attrs:{class:"hljs-number"}},[s._v("0")]),s._v(";\n"),a("span",{attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" queue = [];\n"),a("span",{attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" timer = "),a("span",{attrs:{class:"hljs-function"}},[s._v("("),a("span",{attrs:{class:"hljs-params"}},[s._v("time")]),s._v(") =>")]),s._v(" "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("new")]),s._v(" "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("Promise")]),s._v("("),a("span",{attrs:{class:"hljs-function"}},[s._v("("),a("span",{attrs:{class:"hljs-params"}},[s._v("resolve, reject")]),s._v(") =>")]),s._v(" setTimeout("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("()")]),s._v(" =>")]),s._v(" reject(genRes("),a("span",{attrs:{class:"hljs-string"}},[s._v("'timeout'")]),s._v(")), time))\n"),a("span",{attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" request = "),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("config")]),s._v(" =>")]),s._v(" "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("new")]),s._v(" "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("Promise")]),s._v("("),a("span",{attrs:{class:"hljs-function"}},[s._v("("),a("span",{attrs:{class:"hljs-params"}},[s._v("resolve, reject")]),s._v(") =>")]),s._v(" {\n  "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("let")]),s._v(" task\n  "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" (MAX >= counts++) {\n    "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" item = "),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("()")]),s._v(" =>")]),s._v(" (task = wx.request(genOpt(config, resolve, reject)))\n    queue.push()\n    task = {\n      abort() {\n        "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" (queue.indexOf(item) > "),a("span",{attrs:{class:"hljs-number"}},[s._v("-1")]),s._v(") {\n          queue.splice(queue.indexOf(item), "),a("span",{attrs:{class:"hljs-number"}},[s._v("1")]),s._v(")\n          reject(genRes("),a("span",{attrs:{class:"hljs-string"}},[s._v("'abort'")]),s._v("))\n        } "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("else")]),s._v(" {\n          task.abort()\n        }\n      }\n    }\n  } "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("else")]),s._v(" {\n    task = wx.request(genOpt(config, resolve, reject))\n  }\n  "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" ("),a("span",{attrs:{class:"hljs-keyword"}},[s._v("typeof")]),s._v(" config.requested === "),a("span",{attrs:{class:"hljs-string"}},[s._v("'function'")]),s._v(") {\n    config.requested(task)\n  }\n})\n"),a("span",{attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" finishQueue = "),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("()")]),s._v(" =>")]),s._v(" {\n  counts--;\n  queue.length > "),a("span",{attrs:{class:"hljs-number"}},[s._v("0")]),s._v(" && queue.shift()()\n}\n"),a("span",{attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" wxFetch = "),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("config")]),s._v(" =>")]),s._v(" {\n  "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" list = [request(config)]\n  "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("typeof")]),s._v(" config.timeout === "),a("span",{attrs:{class:"hljs-string"}},[s._v("'number'")]),s._v(" && list.push(timer(config.timeout))\n  "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("Promise")]),s._v(".race(list).then("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("res")]),s._v(" =>")]),s._v(" {\n    finishQueue()\n    "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" res\n  }, err => {\n    finishQueue()\n    "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("Promise")]),s._v(".reject(err)\n  })\n}\n\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("// 业务代码")]),s._v("\nwxFetch({\n  requested(task) {\n    setTimeout("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("()")]),s._v(" =>")]),s._v(" {\n      task.abort()\n    }, "),a("span",{attrs:{class:"hljs-number"}},[s._v("500")]),s._v(")\n  }\n}).then("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("res")]),s._v(" =>")]),s._v(" {\n  "),a("span",{attrs:{class:"hljs-comment"}},[s._v("// ...")]),s._v("\n}, err => {\n  "),a("span",{attrs:{class:"hljs-comment"}},[s._v("// ...")]),s._v("\n})\n")])])}]},e=a("VU/8")(null,n,!1,null,null,null);t.default=e.exports},u4kN:function(s,t,a){s.exports=a("RPdL")}});
//# sourceMappingURL=14.e6c314e7eaf650c70d38.js.map