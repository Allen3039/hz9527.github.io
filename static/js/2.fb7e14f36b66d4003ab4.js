webpackJsonp([2],{Py6i:function(s,t,a){s.exports=a.p+"static/img/eventLoop.a5d4c98.jpg"},rd5k:function(s,t,a){s.exports=a("tlxI")},tlxI:function(s,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n={render:function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("section",[a("h2",{attrs:{id:"事件循环的一点疑惑"}},[s._v("事件循环的一点疑惑")]),s._v(" "),a("div",{staticClass:"aside-menu"},[a("div",{directives:[{name:"toggle",rawName:"v-toggle"}],staticClass:"aside-menu-tit"},[s._v("menu")]),s._v(" "),s._m(0)]),a("b",{staticClass:"update-time"},[s._v(s._s(s._f("formatTime")(1560665780980)))]),a("b",{staticClass:"type"},[s._v("其他")]),s._v(" "),a("b",{staticClass:"kw"},[s._v("promise")]),s._v(" "),a("b",{staticClass:"kw"},[s._v("事件循环")]),s._v(" "),a("b",{staticClass:"kw"},[s._v("宏队列与微队列")]),s._v(" "),s._m(1),s._v(" "),a("h3",{attrs:{id:"关于 promise 有话说"}},[s._v("关于 promise 有话说")]),s._v(" "),a("p",[s._v("先看题")]),s._v(" "),s._m(2),s._v(" "),a("p",[s._v("咋一看，你的答案可能是这样：")]),s._v(" "),s._m(3),s._v(" "),a("h4",{attrs:{id:"分析"}},[s._v("分析")]),s._v(" "),s._m(4),s._v(" "),s._m(5),s._v(" "),a("p",[s._v("我们现在用两格短线表示 then 的时间，上面是 promise1 下面是 promise2")]),s._v(" "),s._m(6),s._v(" "),s._m(7),s._v(" "),a("p",[s._v("我们尝试加一下 性能测试 performance.now()，图又是什么样子的呢？")]),s._v(" "),s._m(8),s._v(" "),s._m(9),s._v(" "),s._m(10),s._v(" "),s._m(11),s._v(" "),a("h4",{attrs:{id:"总结"}},[s._v("总结")]),s._v(" "),a("p",[s._v("then 方法内部实现看来比我想的简单，却存在坑了，因为原本一次事件循环搞定现在却只能通过三次，启发在于 catch 的使用")]),s._v(" "),s._m(12),s._v(" "),a("p",[s._v("显然是先 catch2")]),s._v(" "),a("h3",{attrs:{id:"关于 macrotask & microtask"}},[s._v("关于 macrotask & microtask")]),s._v(" "),s._m(13),s._v(" "),a("h4",{attrs:{id:"一次事件循环只执行一个 macrotask"}},[s._v("一次事件循环只执行一个 macrotask")]),s._v(" "),a("p",[s._v("看一个例子")]),s._v(" "),s._m(14),s._v(" "),a("p",[s._v("答案是 2 1。或许你这里就算用了 performance 也不能看出端倪，但是我们知道 Promise 是异步就好了")]),s._v(" "),s._m(15),s._v(" "),s._m(16),s._v(" "),s._m(17),s._v(" "),s._m(18),s._v(" "),a("h4",{attrs:{id:"一次事件循环会执行完所有微队列"}},[s._v("一次事件循环会执行完所有微队列")]),s._v(" "),a("p",[s._v("这一部分感觉没什么好说的，但是可以说的是必须清空微队列才会进入新的事件循环，也就是意味着在一个微队列里执行新的微队列会在一次事件循环里")]),s._v(" "),s._m(19)])},staticRenderFns:[function(){var s=this.$createElement,t=this._self._c||s;return t("div",{staticClass:"aside-menu-con"},[t("a",{staticClass:"level-3 aside-menu-item",attrs:{href:"#关于 promise 有话说"}},[this._v("关于 promise 有话说")]),t("a",{staticClass:"level-4 aside-menu-item",attrs:{href:"#分析"}},[this._v("分析")]),t("a",{staticClass:"level-4 aside-menu-item",attrs:{href:"#总结"}},[this._v("总结")]),t("a",{staticClass:"level-3 aside-menu-item",attrs:{href:"#关于 macrotask & microtask"}},[this._v("关于 macrotask & microtask")]),t("a",{staticClass:"level-4 aside-menu-item",attrs:{href:"#一次事件循环只执行一个 macrotask"}},[this._v("一次事件循环只执行一个 macrotask")]),t("a",{staticClass:"level-4 aside-menu-item",attrs:{href:"#一次事件循环会执行完所有微队列"}},[this._v("一次事件循环会执行完所有微队列")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("blockquote",[t("p",[this._v("我们知道 js 是单线程执行的，但是借助宿主，可以获得异步的能力，在浏览器中依赖 webAPI，在 node 中依赖 libuv\n但是这还不够。我们还需要区分 宏队列（macrotask）和微队列（microtask）。我们知道是先执行微队列再执行宏队列")])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("details",[a("summary",[s._v("js")]),s._v(" "),a("pre",{pre:!0},[a("code",{attrs:{"v-pre":"",class:"language-js"}},[a("span",{attrs:{class:"hljs-keyword"}},[s._v("new")]),s._v(" "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("Promise")]),s._v("("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("resolve")]),s._v(" =>")]),s._v(" {\n  "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log("),a("span",{attrs:{class:"hljs-string"}},[s._v("'promise1'")]),s._v(")\n  resolve("),a("span",{attrs:{class:"hljs-number"}},[s._v("1")]),s._v(")\n}).then("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("res")]),s._v(" =>")]),s._v(" {\n  "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log("),a("span",{attrs:{class:"hljs-string"}},[s._v("'promise1'")]),s._v(", ++res)\n  "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" res\n}).then("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("res")]),s._v(" =>")]),s._v(" {\n  "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log("),a("span",{attrs:{class:"hljs-string"}},[s._v("'promise1'")]),s._v(", ++res)\n  "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("Promise")]),s._v(".resolve(res) "),a("span",{attrs:{class:"hljs-comment"}},[s._v("// 注意这里不一样")]),s._v("\n}).then("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("res")]),s._v(" =>")]),s._v(" {\n  "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log("),a("span",{attrs:{class:"hljs-string"}},[s._v("'promise1'")]),s._v(", ++res)\n  "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" res\n}).then("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("res")]),s._v(" =>")]),s._v(" {\n  "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log("),a("span",{attrs:{class:"hljs-string"}},[s._v("'promise1'")]),s._v(", ++res)\n  "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" res\n}).then("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("res")]),s._v(" =>")]),s._v(" {\n  "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log("),a("span",{attrs:{class:"hljs-string"}},[s._v("'promise1'")]),s._v(", ++res)\n  "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" res\n})\n\n"),a("span",{attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log("),a("span",{attrs:{class:"hljs-string"}},[s._v("'normal'")]),s._v(")\n\n"),a("span",{attrs:{class:"hljs-keyword"}},[s._v("new")]),s._v(" "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("Promise")]),s._v("("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("resolve")]),s._v(" =>")]),s._v(" {\n  "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log("),a("span",{attrs:{class:"hljs-string"}},[s._v("'promise2'")]),s._v(")\n  resolve("),a("span",{attrs:{class:"hljs-number"}},[s._v("1")]),s._v(")\n}).then("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("res")]),s._v(" =>")]),s._v(" {\n  "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log("),a("span",{attrs:{class:"hljs-string"}},[s._v("'promise2'")]),s._v(", ++res)\n  "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" res\n}).then("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("res")]),s._v(" =>")]),s._v(" {\n  "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log("),a("span",{attrs:{class:"hljs-string"}},[s._v("'promise2'")]),s._v(", ++res)\n  "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" res\n}).then("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("res")]),s._v(" =>")]),s._v(" {\n  "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log("),a("span",{attrs:{class:"hljs-string"}},[s._v("'promise2'")]),s._v(", ++res)\n  "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" res\n}).then("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("res")]),s._v(" =>")]),s._v(" {\n  "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log("),a("span",{attrs:{class:"hljs-string"}},[s._v("'promise2'")]),s._v(", ++res)\n  "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" res\n}).then("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("res")]),s._v(" =>")]),s._v(" {\n  "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log("),a("span",{attrs:{class:"hljs-string"}},[s._v("'promise2'")]),s._v(", ++res)\n  "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" res\n})\n")])])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("pre",{pre:!0},[a("code",{attrs:{"v-pre":"",class:"language-js"}},[a("span",{attrs:{class:"hljs-comment"}},[s._v("// 一开始以为的：    实际是这样：")]),s._v("\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("// promise1        嗯，你是对的")]),s._v("\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("// normal          嗯，你是对的")]),s._v("\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("// promise2        嗯，你是对的")]),s._v("\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("// promise1 2      嗯，你是对的")]),s._v("\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("// promise2 2      嗯，你是对的")]),s._v("\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("// promise1 3      嗯，你是对的")]),s._v("\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("// promise2 3      嗯，你是对的")]),s._v("\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("// promise2 4      嗯，你是对的")]),s._v("\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("// promise1 4      promise2 5")]),s._v("\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("// promise2 5      promise1 4")]),s._v("\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("// promise1 5      promise2 6")]),s._v("\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("// promise2 6      promise1 5")]),s._v("\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("// promise1 6      嗯，你是对的")]),s._v("\n")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("如果知道事件循环，前面到 "),t("code",{pre:!0},[this._v("Promise.resolve(res)")]),this._v(" 没什么可说的。关键是后面发生了什么？为什么慢两个拍？")])},function(){var s=this.$createElement,t=this._self._c||s;return t("blockquote",[t("p",[this._v("我们知道 promise 在 resolver 和 rejecter 可以返回 promise，并且这个 promise 的返回将传递给后续的 resolver 或 rejecter\n而 promise 本身在 then cache 也会返回一个 promise，这也是为什么可以被链式调用，而其状态取决于当前 状态，这也是为什么有值的穿透这个现象了\n但是")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("pre",{pre:!0},[t("code",{attrs:{"v-pre":"",class:"language-sh"}},[this._v("2  3     4  5  6\n|__|__ __|__|__|\n\n2  3  4  5  6\n|__|__|__|__|\n")])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("p",[s._v("现在大概知道不是 "),a("code",{pre:!0},[s._v("promise2 4 => promise1 4 => promise2 5 => promise1 5 => promise2 6 => promise1 6")]),s._v(" 了"),a("br"),s._v("\n但是为什么是 "),a("code",{pre:!0},[s._v("promise2 4 => promise2 5 => promise1 4 => promise2 6 => promise2 5 => promise1 6")]),s._v(" ?"),a("br"),s._v("\n问题在于 "),a("code",{pre:!0},[s._v("promise2 5")]),s._v(" 在 "),a("code",{pre:!0},[s._v("promise1 4")]),s._v(" 之前执行？")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("pre",{pre:!0},[a("code",{attrs:{"v-pre":"",class:"language-sh"}},[a("span",{attrs:{class:"hljs-comment"}},[s._v("# promise1 2 1716.5999999997439")]),s._v("\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("# promise2 2 1717.3000000038883")]),s._v("\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("# promise1 3 1717.800000013085")]),s._v("\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("# promise2 3 1718.1000000127824")]),s._v("\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("# promise2 4 1718.5000000026776")]),s._v("\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("# promise2 5 1718.9000000071246")]),s._v("\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("# promise1 4 1719.200000006822")]),s._v("\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("# promise2 6 1719.600000011269")]),s._v("\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("# promise1 5 1720.0000000011642")]),s._v("\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("# promise1 6 1720.3000000008615")]),s._v("\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("# 很不幸，经过多次测试我们发现 promise1 4 一直介于 promise2 5、6之间，这个就回到事件循环本质上了，每一个 then 都是在微队列的一个切片上，不会重合，所以上面的图如下：")]),s._v("\n2  3        4  5  6\n|__|_____ __|__|__|\n\n 2  3  4  5  6\n |__|__|__|__|\n")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("blockquote",[t("p",[this._v("看到这里我好像明白了，看来 promise 垫片需要重写了，因为返回 Promise 并不是让其代替默认返回的 Promise 而是照常返回，只是 value 是 Promise 实例\n显然事件循环是在 resolve reject 内部实现")])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("details",[a("summary",[s._v("js")]),s._v(" "),a("pre",{pre:!0},[a("code",{attrs:{"v-pre":"",class:"language-js"}},[a("span",{attrs:{class:"hljs-built_in"}},[s._v("Promise")]),s._v(".resolve = "),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v("("),a("span",{attrs:{class:"hljs-params"}},[s._v("result")]),s._v(") ")]),s._v("{\n  "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("new")]),s._v(" "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("Promise")]),s._v("("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("resolve")]),s._v(" =>")]),s._v(" {\n    "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" (result && result.constructor === "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("Promise")]),s._v(") {\n      result.then(resolve)\n    } "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("else")]),s._v(" {\n      resolve(result)\n    }\n  })\n}\n\n"),a("span",{attrs:{class:"hljs-built_in"}},[s._v("Promise")]),s._v(".prototype.then = "),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v("("),a("span",{attrs:{class:"hljs-params"}},[s._v("fn, fn2")]),s._v(") ")]),s._v("{\n  "),a("span",{attrs:{class:"hljs-comment"}},[s._v("// 省略状态判断")]),s._v("\n  "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("Promise")]),s._v(".resolve(fn("),a("span",{attrs:{class:"hljs-keyword"}},[s._v("this")]),s._v(".data))\n}\n\n"),a("span",{attrs:{class:"hljs-comment"}},[s._v("// 可能还是懵的，那我们再来看 返回 Promise.resolve(res)即 result就是 Promise.resolve(res)")]),s._v("\n"),a("span",{attrs:{class:"hljs-built_in"}},[s._v("Promise")]),s._v(".resolve = "),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v("("),a("span",{attrs:{class:"hljs-params"}},[s._v("result")]),s._v(") ")]),s._v("{\n  "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("new")]),s._v(" "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("Promise")]),s._v("("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("resolve")]),s._v(" =>")]),s._v(" {\n    "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" (result && result.constructor === "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("Promise")]),s._v(") {\n      "),a("span",{attrs:{class:"hljs-comment"}},[s._v("// Promise.resolve(res).then(resolve)")]),s._v("\n      "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("let")]),s._v(" pro = "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("Promise")]),s._v(".resolve(res) "),a("span",{attrs:{class:"hljs-comment"}},[s._v("// Promise.resolve 内部调用一次 resolve")]),s._v("\n      pro.then(fn) "),a("span",{attrs:{class:"hljs-comment"}},[s._v("// then 内部调用 Promise.resolve, Promise.resolve 调用 resolve 两次了")]),s._v("\n      "),a("span",{attrs:{class:"hljs-comment"}},[s._v("// 这里 fn 就是 resolve 一共三次，所以间隔了三次事件循环")]),s._v("\n    } "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("else")]),s._v(" {\n      resolve(result)\n    }\n  })\n}\n")])])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("现在终于能解释为什么 "),t("code",{pre:!0},[this._v("return Promise.resolve(res)")]),this._v(" 间隔了三次事件循环了")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("pre",{pre:!0},[a("code",{attrs:{"v-pre":"",class:"language-js"}},[a("span",{attrs:{class:"hljs-keyword"}},[s._v("new")]),s._v(" "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("Promise")]),s._v("("),a("span",{attrs:{class:"hljs-function"}},[s._v("("),a("span",{attrs:{class:"hljs-params"}},[s._v("resolve, reject")]),s._v(") =>")]),s._v(" {\n  reject("),a("span",{attrs:{class:"hljs-number"}},[s._v("1")]),s._v(")\n}).then("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("res")]),s._v(" =>")]),s._v(" "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log(res, "),a("span",{attrs:{class:"hljs-string"}},[s._v("'promise1Resolved'")]),s._v("))\n.catch("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("err")]),s._v(" =>")]),s._v(" "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log(err, "),a("span",{attrs:{class:"hljs-string"}},[s._v("'promise1Rejected'")]),s._v("))\n\n"),a("span",{attrs:{class:"hljs-keyword"}},[s._v("new")]),s._v(" "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("Promise")]),s._v("("),a("span",{attrs:{class:"hljs-function"}},[s._v("("),a("span",{attrs:{class:"hljs-params"}},[s._v("resolve, reject")]),s._v(") =>")]),s._v(" {\n  reject("),a("span",{attrs:{class:"hljs-number"}},[s._v("1")]),s._v(")\n}).then("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("res")]),s._v(" =>")]),s._v(" "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log(res, "),a("span",{attrs:{class:"hljs-string"}},[s._v("'promise2Resolved'")]),s._v("), err => "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log(err, "),a("span",{attrs:{class:"hljs-string"}},[s._v("'promise2Rejected'")]),s._v("))\n")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("先祭出一张图吧"),t("br"),this._v(" "),t("img",{attrs:{src:a("Py6i"),width:"500px"}})])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("pre",{pre:!0},[a("code",{attrs:{"v-pre":"",class:"language-js"}},[s._v("setTimeout("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("()")]),s._v(" =>")]),s._v(" {\n  "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("Promise")]),s._v(".resolve("),a("span",{attrs:{class:"hljs-number"}},[s._v("2")]),s._v(")\n    .then("),a("span",{attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log)\n}, "),a("span",{attrs:{class:"hljs-number"}},[s._v("0")]),s._v(")\n\nsetTimeout("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("()")]),s._v(" =>")]),s._v(" {\n  "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log("),a("span",{attrs:{class:"hljs-number"}},[s._v("1")]),s._v(")\n}, "),a("span",{attrs:{class:"hljs-number"}},[s._v("0")]),s._v(")\n")])])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("pre",{pre:!0},[a("code",{attrs:{"v-pre":"",class:"language-xml"}},[a("span",{attrs:{class:"hljs-meta"}},[s._v("<!DOCTYPE html>")]),s._v("\n"),a("span",{attrs:{class:"hljs-tag"}},[s._v("<"),a("span",{attrs:{class:"hljs-name"}},[s._v("html")]),s._v(" "),a("span",{attrs:{class:"hljs-attr"}},[s._v("lang")]),s._v("="),a("span",{attrs:{class:"hljs-string"}},[s._v('"en"')]),s._v(">")]),s._v("\n"),a("span",{attrs:{class:"hljs-tag"}},[s._v("<"),a("span",{attrs:{class:"hljs-name"}},[s._v("head")]),s._v(">")]),s._v("\n  "),a("span",{attrs:{class:"hljs-tag"}},[s._v("<"),a("span",{attrs:{class:"hljs-name"}},[s._v("title")]),s._v(">")]),s._v("test macrotask"),a("span",{attrs:{class:"hljs-tag"}},[s._v("</"),a("span",{attrs:{class:"hljs-name"}},[s._v("title")]),s._v(">")]),s._v("\n"),a("span",{attrs:{class:"hljs-tag"}},[s._v("</"),a("span",{attrs:{class:"hljs-name"}},[s._v("head")]),s._v(">")]),s._v("\n"),a("span",{attrs:{class:"hljs-tag"}},[s._v("<"),a("span",{attrs:{class:"hljs-name"}},[s._v("body")]),s._v(">")]),s._v("\n    "),a("span",{attrs:{class:"hljs-tag"}},[s._v("<"),a("span",{attrs:{class:"hljs-name"}},[s._v("div")]),s._v(" "),a("span",{attrs:{class:"hljs-attr"}},[s._v("class")]),s._v("="),a("span",{attrs:{class:"hljs-string"}},[s._v('"test"')]),s._v(">")]),s._v("123"),a("span",{attrs:{class:"hljs-tag"}},[s._v("</"),a("span",{attrs:{class:"hljs-name"}},[s._v("div")]),s._v(">")]),s._v("\n    "),a("span",{attrs:{class:"hljs-tag"}},[s._v("<"),a("span",{attrs:{class:"hljs-name"}},[s._v("script")]),s._v(">")]),a("span",{attrs:{class:"javascript"}},[s._v("\n      "),a("span",{attrs:{class:"hljs-keyword"}},[s._v("let")]),s._v(" test = "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("document")]),s._v(".querySelector("),a("span",{attrs:{class:"hljs-string"}},[s._v("'.test'")]),s._v(")\n      setTimeout("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("()")]),s._v(" =>")]),s._v(" {\n        setTimeout("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("()")]),s._v(" =>")]),s._v(" {\n          test.style.width = "),a("span",{attrs:{class:"hljs-string"}},[s._v("'300px'")]),s._v("\n          "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("Promise")]),s._v(".resolve(performance.now())\n            .then("),a("span",{attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log)\n        }, "),a("span",{attrs:{class:"hljs-number"}},[s._v("0")]),s._v(")\n        setTimeout("),a("span",{attrs:{class:"hljs-function"}},[a("span",{attrs:{class:"hljs-params"}},[s._v("()")]),s._v(" =>")]),s._v(" {\n          test.style.width = "),a("span",{attrs:{class:"hljs-string"}},[s._v("'200px'")]),s._v(" "),a("span",{attrs:{class:"hljs-comment"}},[s._v("// 需要重排才行，如果一个引发重绘一个引发重排也不会 render")]),s._v("\n          "),a("span",{attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log(performance.now(), "),a("span",{attrs:{class:"hljs-string"}},[s._v("'timer2'")]),s._v(")\n        }, "),a("span",{attrs:{class:"hljs-number"}},[s._v("0")]),s._v(")\n      }, "),a("span",{attrs:{class:"hljs-number"}},[s._v("300")]),s._v(") "),a("span",{attrs:{class:"hljs-comment"}},[s._v("// 需要 firstRender 完成")]),s._v("\n    ")]),a("span",{attrs:{class:"hljs-tag"}},[s._v("</"),a("span",{attrs:{class:"hljs-name"}},[s._v("script")]),s._v(">")]),s._v("\n"),a("span",{attrs:{class:"hljs-tag"}},[s._v("</"),a("span",{attrs:{class:"hljs-name"}},[s._v("body")]),s._v(">")]),s._v("\n"),a("span",{attrs:{class:"hljs-tag"}},[s._v("</"),a("span",{attrs:{class:"hljs-name"}},[s._v("html")]),s._v(">")]),s._v("\n")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("好吧，我承认为了把它们分到两次事件循环花了很长时间（更新了 Chrome 就不行了。。。。），因为浏览器实在太聪明了！！！"),t("br"),this._v("\n首先完整的事件循环并不是 run 一个 macrotask 后立马 render 而是 判断是否需要重现渲染。这个完全就是看浏览器心情了。。。。"),t("br"),this._v("\n根据上面的例子我们得到的结论就是 "),t("strong",[this._v("每次事件循环只执行一个 macrotask")]),this._v(" ，但是问题来了")])},function(){var s=this.$createElement,t=this._self._c||s;return t("ol",[t("li",[this._v("如果把前一个 time 改为 1 会先执行哪个？")]),this._v(" "),t("li",[this._v("我们在写动画时用 setTimeout 0 会发生什么？")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("第一个问题的答案是不确定，完全看心情，笔者使用 chrmoe 基本是间隔 2 毫秒才会先执行第二个，但至少可以确定的是 不一定 根据 time（间隔比较小） 参数来决定 installTimer 顺序"),t("br"),this._v("\n第二个问题 浏览器真的很聪明，我使用的 chrome 开始一般 合并 3-4 帧，然后 合并 10 多帧，最后基本是 7-8 帧，才渲染一次（不管是是否引发重排）")])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[t("b",{staticClass:"show-blog"},[this._v("true")])])}]},r=a("VU/8")(null,n,!1,null,null,null);t.default=r.exports}});
//# sourceMappingURL=2.fb7e14f36b66d4003ab4.js.map